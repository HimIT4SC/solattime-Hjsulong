<!DOCTYPE html>
<html lang="th" id="html-root">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TAQWEEM - Waktu Solat</title>
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#10b981">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Taqweem">
    <link rel="apple-touch-icon" href="taqweem.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { darkMode: 'class' };
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&family=Kanit:wght@300;400;500;600&display=swap');

        :root {
            --primary: #10b981;
            --primary-dark: #059669;
        }

        body {
            font-family: 'Plus Jakarta Sans', 'Kanit', sans-serif;
            background: #f8fafc;
            color: #1e293b;
            transition: background 0.3s ease, color 0.3s ease;
            overflow-x: hidden;
        }

        html.dark body {
            background: #0f172a;
            color: #f1f5f9;
        }

        /* Mesh Gradient Background */
        .mesh-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: radial-gradient(at 0% 0%, rgba(16, 185, 129, 0.1) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(20, 184, 166, 0.1) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(5, 150, 105, 0.05) 0px, transparent 50%);
        }

        /* Glassmorphism Effect */
        .glass-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 24px;
        }

        html.dark .glass-card {
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .active-prayer-card {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white !important;
            transform: scale(1.02);
            box-shadow: 0 10px 25px -5px rgba(16, 185, 129, 0.4);
        }

        /* Current Prayer Banner */
        .current-banner {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(16, 185, 129, 0.08);
            border: 1px solid rgba(16, 185, 129, 0.2);
            border-radius: 16px;
            padding: 10px 16px;
            margin-bottom: 12px;
        }

        html.dark .current-banner {
            background: rgba(16, 185, 129, 0.1);
            border-color: rgba(16, 185, 129, 0.25);
        }

        .current-banner .pulse-dot {
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            flex-shrink: 0;
            animation: pulse-dot 1.8s ease-in-out infinite;
        }

        @keyframes pulse-dot {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.4;
                transform: scale(0.7);
            }
        }

        /* Hide Scrollbar */
        ::-webkit-scrollbar {
            display: none;
        }


        /* Dark Mode Toggle Button */
        #theme-toggle {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            border: 1px solid rgba(0, 0, 0, 0.08);
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.25s, transform 0.2s, border-color 0.25s;
            flex-shrink: 0;
        }

        #theme-toggle:hover {
            transform: scale(1.1);
        }

        html.dark #theme-toggle {
            background: rgba(30, 41, 59, 0.7);
            border-color: rgba(255, 255, 255, 0.08);
        }


        /* Live clock pulse */
        @keyframes clockPulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.65;
            }
        }

        @keyframes scaleUp {
            from {
                opacity: 0;
                transform: scale(0.9);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .animate-scale-up {
            animation: scaleUp 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        .live-clock {
            animation: clockPulse 2s ease-in-out infinite;
        }

        /* Animations */
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-slide-up {
            animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        /* ‚îÄ‚îÄ Responsive Layout ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        @media (min-width: 1024px) {

            /* Stack rows vertically */
            .layout-wrapper {
                display: flex;
                flex-direction: column;
                gap: 28px;
            }

            /* Row 1: featured card ‚Äî full width, same as prayer row */
            .layout-left {
                width: 100%;
            }

            /* Row 2: prayer times ‚Äî all in one horizontal row */
            .layout-right {
                width: 100%;
            }

            #prayer-list {
                display: flex !important;
                flex-direction: row;
                gap: 10px;
            }

            /* Each prayer card fills equal width */
            #prayer-list>* {
                flex: 1;
                min-width: 0;
                margin-top: 0 !important;
            }

            /* Compact prayer cards for horizontal row */
            #prayer-list .glass-card,
            #prayer-list .active-prayer-card {
                flex-direction: column !important;
                align-items: center !important;
                justify-content: center !important;
                text-align: center;
                padding: 14px 8px !important;
                gap: 8px;
            }

            #prayer-list .glass-card>div,
            #prayer-list .active-prayer-card>div {
                flex-direction: column !important;
                align-items: center !important;
                gap: 6px !important;
                text-align: center !important;
            }
        }
    </style>
    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-MNKL224MR5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-MNKL224MR5');
</script>
</head>

<body class="pb-8">
    <div class="mesh-bg"></div>

    <div class="max-w-5xl mx-auto px-5 pt-8">
        <!-- Header Section -->
        <header class="flex flex-col lg:flex-row lg:justify-between lg:items-center gap-3 mb-8 animate-slide-up">
            <div class="text-center lg:text-left">
                <h1 class="text-2xl font-bold tracking-tight">TAQWEEM</h1>
                <h2 id="greeting-text" class="text-slate-400 font-medium text-sm">Haji Sulong</h2>
            </div>
            <div class="flex items-center gap-1.5 flex-wrap justify-center lg:justify-end">
                <!-- Language switcher -->
                <div class="relative">
                    <select id="lang-select"
                        class="bg-white/50 dark:bg-slate-800/50 backdrop-blur-md border border-slate-200 dark:border-slate-700 rounded-full px-3 py-1 text-xs font-medium outline-none appearance-none pr-6">
                        <option value="th">TH</option>
                        <option value="en">ENG</option>
                        <option value="ms">MY</option>
                    </select>
                    <i
                        class="fas fa-chevron-down absolute right-2 top-1/2 -translate-y-1/2 text-[9px] text-slate-400"></i>
                </div>
                <!-- Notification Toggle -->
                <button id="noti-toggle" title="Enable Notifications" aria-label="Toggle notifications"
                    class="bg-white/50 dark:bg-slate-800/50 backdrop-blur-md border border-slate-200 dark:border-slate-700 rounded-lg w-8 h-8 flex items-center justify-center transition-all hover:scale-110 active:scale-95 text-xs text-slate-400">
                    <i id="noti-icon" class="fas fa-bell-slash"></i>
                </button>
                <!-- Theme Toggle -->
                <button id="theme-toggle" title="Toggle dark/light mode" aria-label="Toggle theme">
                    <span id="theme-icon">üåô</span>
                </button>
                <!-- Font size controls -->
                <div class="flex items-center gap-1">
                    <button id="font-decrease" title="Decrease text size"
                        class="w-6 h-6 rounded-full bg-white/50 dark:bg-slate-800/50 backdrop-blur-md border border-slate-200 dark:border-slate-700 text-[10px] font-bold flex items-center justify-center hover:scale-110 transition-transform"
                        aria-label="Decrease font size">A‚àí</button>
                    <button id="font-increase" title="Increase text size"
                        class="w-6 h-6 rounded-full bg-white/50 dark:bg-slate-800/50 backdrop-blur-md border border-slate-200 dark:border-slate-700 text-[10px] font-bold flex items-center justify-center hover:scale-110 transition-transform"
                        aria-label="Increase font size">A+</button>
                </div>
                <!-- Location -->
                <div class="relative">
                    <select id="location-select"
                        class="bg-white/50 dark:bg-slate-800/50 backdrop-blur-md border border-slate-200 dark:border-slate-700 rounded-full px-3 py-1 text-xs font-medium outline-none appearance-none pr-6">
                        <!-- Dynamic -->
                    </select>
                    <i
                        class="fas fa-chevron-down absolute right-2 top-1/2 -translate-y-1/2 text-[9px] text-slate-400"></i>
                </div>
            </div>
        </header>

        <!-- Two-column layout for lg screens -->
        <div class="layout-wrapper">

            <!-- LEFT: Current banner + Next prayer card -->
            <div class="layout-left">

                <!-- PWA Install Banner -->
                <div id="pwa-install-banner" class="mb-6 animate-slide-up hidden">
                    <div class="glass-card px-4 py-3 flex items-center justify-between gap-3 border-emerald-500/10">
                        <div class="flex items-center gap-3">
                            <img src="taqweem.png" class="w-10 h-10 object-contain rounded-xl shadow-sm" alt="Logo">
                            <div>
                                <p class="text-[13px] font-bold text-slate-800 dark:text-slate-100">‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏≠‡∏õ Taqweem
                                </p>
                                <p id="pwa-install-hint" class="text-[10px] text-slate-400">‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏ß ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå‡πÑ‡∏î‡πâ
                                </p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 flex-shrink-0">
                            <button id="pwa-install-btn"
                                class="bg-emerald-500 hover:bg-emerald-600 text-white text-xs font-bold px-4 py-2 rounded-full shadow shadow-emerald-500/30 transition-all active:scale-95">
                                <i class="fas fa-download mr-1"></i> ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á
                            </button>
                            <button id="pwa-dismiss-btn"
                                class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 text-lg leading-none px-1"
                                aria-label="Dismiss">&times;</button>
                        </div>
                    </div>
                </div>

                <!-- Current Prayer Banner -->
                <div id="current-prayer-banner" class="current-banner animate-slide-up hidden"
                    style="animation-delay: 0.05s;">
                    <span class="pulse-dot"></span>
                    <span id="lbl-currently"
                        class="text-[11px] font-medium text-emerald-600 dark:text-emerald-400"></span>
                    <span id="current-prayer-label"
                        class="text-[13px] font-bold text-slate-800 dark:text-slate-100">--</span>
                    <span id="current-prayer-time-label"
                        class="text-[12px] font-semibold text-emerald-500 ml-auto">--:--</span>
                </div>

                <!-- Main Featured Card (Next Prayer) -->
                <div id="next-prayer-banner" class="glass-card p-6 mb-8 animate-slide-up"
                    style="animation-delay: 0.1s;">
                    <div class="flex items-center gap-4 mb-2">
                        <div class="flex-shrink-0">
                            <img src="taqweem.png" alt="Taqweem" class="h-14 w-14 object-contain drop-shadow-sm">
                        </div>
                        <div class="ml-auto text-right">
                            <span id="lbl-next-prayer"
                                class="text-[10px] font-bold uppercase tracking-[0.2em] text-emerald-500 dark:text-emerald-400"></span>
                            <h2 id="next-prayer-name" class="text-2xl font-bold mt-1 tracking-tight">--:--</h2>
                        </div>
                    </div>

                    <div class="flex items-end justify-between">
                        <div>
                            <!-- Live current time -->
                            <div class="flex items-center gap-2">
                                <span
                                    class="w-2 h-2 rounded-full bg-emerald-500 shadow shadow-emerald-400/60 flex-shrink-0"
                                    style="animation: clockPulse 1.5s ease-in-out infinite;"></span>
                                <p id="live-clock"
                                    class="live-clock text-3xl font-bold text-emerald-500 dark:text-emerald-400 tracking-tighter tabular-nums">
                                    --:--:--</p>
                            </div>
                            <p id="current-date-text" class="text-slate-400 text-xs mt-1 ml-4">-- --- ----</p>
                            <div class="flex items-center gap-1.5 mt-0.5 ml-4">
                                <span id="hijri-date-text" class="text-emerald-500/80 text-[10px] font-medium"></span>
                                <button id="hijri-minus" title="Hijri -1 day"
                                    class="w-4 h-4 rounded-full bg-emerald-500/10 hover:bg-emerald-500/25 text-emerald-600 dark:text-emerald-400 text-[9px] font-bold flex items-center justify-center transition-colors">&minus;</button>
                                <button id="hijri-plus" title="Hijri +1 day"
                                    class="w-4 h-4 rounded-full bg-emerald-500/10 hover:bg-emerald-500/25 text-emerald-600 dark:text-emerald-400 text-[9px] font-bold flex items-center justify-center transition-colors">&plus;</button>
                                <span id="hijri-offset-badge" class="text-[9px] text-slate-400 hidden"></span>
                            </div>
                        </div>
                        <div class="text-right flex flex-col items-end gap-2">
                            <!-- Next prayer time (big) -->
                            <p id="next-prayer-time"
                                class="text-2xl font-bold text-slate-800 dark:text-white tracking-tighter tabular-nums">
                                --:--</p>
                            <!-- Countdown -->
                            <p id="countdown-text"
                                class="bg-emerald-500 text-white text-[11px] font-bold px-3 py-1.5 rounded-full shadow-lg shadow-emerald-500/20">
                                ‡πÉ‡∏ô‡∏≠‡∏µ‡∏Å -- ‡∏ä‡∏°. -- ‡∏ô‡∏≤‡∏ó‡∏µ
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RIGHT: Prayer List -->
            <div class="layout-right">
                <div class="space-y-4 animate-slide-up" style="animation-delay: 0.2s;">
                    <div class="flex justify-between items-center px-1">
                        <h3 id="lbl-today-schedule"
                            class="text-sm font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest"></h3>
                        <span id="lbl-unit" class="text-[10px] text-slate-400"></span>
                    </div>

                    <div id="prayer-list" class="space-y-3">
                        <!-- Items populated by JS -->
                    </div>
                </div>
            </div>

        </div><!-- end layout-wrapper -->

        <!-- Monthly Table -->
        <section class="mt-10 animate-slide-up" style="animation-delay:0.3s;">
            <div class="flex flex-wrap items-center justify-between gap-3 px-1 mb-4">
                <h3 id="lbl-month-table"
                    class="text-sm font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest"></h3>
                <div class="flex items-center gap-2">
                    <select id="table-month-select"
                        class="bg-white/50 dark:bg-slate-800/50 backdrop-blur-md border border-slate-200 dark:border-slate-700 rounded-full px-3 py-1.5 text-xs font-medium outline-none appearance-none">
                    </select>
                </div>
            </div>
            <div class="glass-card overflow-x-auto p-0">
                <table id="month-table" class="w-full text-xs border-collapse min-w-[520px]">
                    <thead>
                        <tr id="month-table-head" class="border-b border-slate-200/50 dark:border-slate-700/50">
                        </tr>
                    </thead>
                    <tbody id="month-table-body">
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Info Footer -->
        <footer class="mt-12 text-center pb-12 opacity-40 animate-slide-up" style="animation-delay: 0.3s;">
            <p id="desc-text" class="text-[9px] mt-1"></p>
            <p class="text-[9px] mt-1">application by IT4SC X CUCI | <span id="app-version">...</span></p>
        </footer>
    </div>


    <script>
        let prayerData = null;

        fetch('https://raw.githubusercontent.com/HimIT4SC/solattime-Hjsulong/main/patani_prayer_times.json')
            .then(r => r.json())
            .then(data => {
                prayerData = data;
                initApp();
            })
            .catch(err => {
                console.error('Failed to load prayer data:', err);
            });

        /* ‚îÄ‚îÄ Translations ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        const T = {
            th: {
                greeting: ['‡∏≠‡∏£‡∏∏‡∏ì‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡πå, ‡∏¢‡∏≤‡∏°‡πÄ‡∏ä‡πâ‡∏≤', '‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, ‡∏¢‡∏≤‡∏°‡∏ö‡πà‡∏≤‡∏¢', '‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, ‡∏¢‡∏≤‡∏°‡πÄ‡∏¢‡πá‡∏ô', '‡∏≠‡∏±‡∏™‡∏•‡∏≤‡∏°‡∏∏‡∏≠‡∏∞‡∏•‡∏±‡∏¢‡∏Å‡∏∏‡∏°, ‡∏¢‡∏≤‡∏°‡∏Ñ‡πà‡∏≥‡∏Ñ‡∏∑‡∏ô'],
                prayerNames: { imsak: '‡∏≠‡∏¥‡∏°‡∏ã‡∏≤‡∏Å', subuh: '‡∏ã‡∏∏‡∏ö‡∏Æ‡∏¥', terbit: '‡∏ä‡∏π‡∏£‡∏π‡∏Å', zohor: '‡∏ã‡∏π‡∏Æ‡∏£‡∏µ', asar: '‡∏≠‡∏±‡∏™‡∏£‡∏µ', maghrib: '‡∏°‡∏±‡∏Å‡∏£‡∏¥‡∏ö', isyak: '‡∏≠‡∏µ‡∏ã‡∏≤' },
                nextPrayer: '‡πÄ‡∏ß‡∏•‡∏≤‡∏ñ‡∏±‡∏î‡πÑ‡∏õ',
                currently: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô:',
                inProgress: '‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ',
                endOfDay: '‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô',
                inPeriod: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ',
                done: '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô',
                todaySchedule: '‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ',
                unit: '‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏≤‡∏ó‡∏µ (M)',
                nav: ['‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å', '‡∏Å‡∏¥‡∏ö‡∏•‡∏±‡∏ï', '‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô', '‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤'],
                dateLocale: 'th-TH'
            },
            en: {
                greeting: ['Good Morning', 'Good Afternoon', 'Good Evening', 'Assalamualaikum'],
                prayerNames: { imsak: 'Imsak', subuh: 'Subuh', terbit: 'Sunrise', zohor: 'Zohor', asar: 'Asar', maghrib: 'Maghrib', isyak: 'Isyak' },
                nextPrayer: 'Next time',
                currently: 'Currently:',
                inProgress: 'In Progress',
                endOfDay: 'End of Day',
                inPeriod: 'In this period',
                done: 'Done',
                todaySchedule: "Today's Schedule",
                unit: 'Unit: min (M)',
                nav: ['Home', 'Qibla', 'Calendar', 'Settings'],
                dateLocale: 'en-GB'
            },
            ms: {
                greeting: ['Selamat Pagi', 'Selamat Tengahari', 'Selamat Petang', 'Assalamualaikum'],
                prayerNames: { imsak: 'Imsak', subuh: 'Subuh', terbit: 'Syuruk', zohor: 'Zohor', asar: 'Asar', maghrib: 'Maghrib', isyak: 'Isyak' },
                nextPrayer: 'Waktu Seterusnya',
                currently: 'Sedang dalam:',
                inProgress: 'Waktu Semasa',
                endOfDay: 'Tamat Hari Ini',
                inPeriod: 'Dalam waktu ini',
                done: 'Selesai',
                todaySchedule: 'Jadual Hari Ini',
                unit: 'Unit: minit (M)',
                nav: ['Utama', 'Kiblat', 'Kalendar', 'Tetapan'],
                dateLocale: 'ms-MY'
            }
        };

        let currentLang = 'th';

        function applyLang(lang) {
            currentLang = lang;
            localStorage.setItem('solat-lang', lang);
            const t = T[lang];

            // Sync dropdown to current lang
            const langSelect = document.getElementById('lang-select');
            if (langSelect) langSelect.value = lang;

            // Static labels
            document.getElementById('lbl-next-prayer').innerText = t.nextPrayer;
            document.getElementById('lbl-currently').innerText = t.currently;
            document.getElementById('lbl-today-schedule').innerText = t.todaySchedule;
            document.getElementById('lbl-unit').innerText = t.unit;


            // Re-render prayer list with new names
            updateUI();
        }

        function initFontSize() {
            const SIZES = [13, 15, 16, 18, 20]; // px steps
            let sizeIdx = parseInt(localStorage.getItem('solat-fontsize') ?? '2');

            function applySize() {
                sizeIdx = Math.max(0, Math.min(SIZES.length - 1, sizeIdx));
                document.documentElement.style.fontSize = SIZES[sizeIdx] + 'px';
                localStorage.setItem('solat-fontsize', sizeIdx);
                document.getElementById('font-decrease').disabled = (sizeIdx === 0);
                document.getElementById('font-increase').disabled = (sizeIdx === SIZES.length - 1);
                document.getElementById('font-decrease').style.opacity = sizeIdx === 0 ? '0.4' : '1';
                document.getElementById('font-increase').style.opacity = sizeIdx === SIZES.length - 1 ? '0.4' : '1';
            }

            document.getElementById('font-decrease').addEventListener('click', () => { sizeIdx--; applySize(); });
            document.getElementById('font-increase').addEventListener('click', () => { sizeIdx++; applySize(); });
            applySize();
        }

        function initApp() {
            initTheme();
            initFontSize();

            // Language switcher
            const savedLang = localStorage.getItem('solat-lang') || 'th';
            const langSelect = document.getElementById('lang-select');
            langSelect.addEventListener('change', () => applyLang(langSelect.value));

            const locSelect = document.getElementById('location-select');

            // Set Data
            document.getElementById('desc-text').innerText = prayerData.settings.description;

            // Populate Locations
            prayerData.settings.location_configs.forEach(loc => {
                const opt = document.createElement('option');
                opt.value = loc.offset;
                opt.textContent = loc.name_en;
                locSelect.appendChild(opt);
            });

            // Restore saved province
            const savedProvince = localStorage.getItem('solat-province');
            if (savedProvince !== null) locSelect.value = savedProvince;

            // Save on change
            locSelect.addEventListener('change', () => {
                localStorage.setItem('solat-province', locSelect.value);
                updateUI();
            });

            // Hijri date offset buttons
            const adjustHijri = (delta) => {
                let offset = parseInt(localStorage.getItem('hijri-offset') || '0') + delta;
                offset = Math.max(-3, Math.min(3, offset)); // clamp ¬±3
                localStorage.setItem('hijri-offset', offset);
                updateUI();
            };
            document.getElementById('hijri-minus').addEventListener('click', () => adjustHijri(-1));
            document.getElementById('hijri-plus').addEventListener('click', () => adjustHijri(1));

            // Apply language (also calls updateUI + sets greeting)
            applyLang(savedLang);

            setInterval(updateUI, 60000);    // Rebuild list every minute
            setInterval(tickCountdown, 1000); // Tick countdown every second
        }

        /* ‚îÄ‚îÄ Theme Toggle ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        function initTheme() {
            const html = document.getElementById('html-root');
            const btn = document.getElementById('theme-toggle');
            const icon = document.getElementById('theme-icon');

            // Determine initial theme: localStorage > system preference
            const saved = localStorage.getItem('solat-theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const isDark = saved ? saved === 'dark' : prefersDark;

            applyTheme(isDark);

            btn.addEventListener('click', () => {
                const nowDark = html.classList.contains('dark');
                applyTheme(!nowDark);
                localStorage.setItem('solat-theme', !nowDark ? 'dark' : 'light');
            });

            function applyTheme(dark) {
                if (dark) {
                    html.classList.add('dark');
                    icon.textContent = '‚òÄÔ∏è';
                    btn.title = 'Switch to light mode';
                } else {
                    html.classList.remove('dark');
                    icon.textContent = 'üåô';
                    btn.title = 'Switch to dark mode';
                }
            }
        }

        function updateUI() {
            const t = T[currentLang];
            const offset = parseInt(document.getElementById('location-select').value);
            const prayerList = document.getElementById('prayer-list');
            const now = new Date();
            const todayKey = `${now.getDate()}-${now.getMonth() + 1}`;

            // Format Date with current language locale
            const dateOptions = { day: 'numeric', month: 'long', year: 'numeric' };
            document.getElementById('current-date-text').innerText = now.toLocaleDateString(t.dateLocale, dateOptions);

            // Hijri date using built-in Intl API + custom month mapping for reliability
            try {
                const hijriOffset = parseInt(localStorage.getItem('hijri-offset') || '0');
                const hijriDate = new Date(now.getTime() + hijriOffset * 86400000);

                // Define Hijri months for all supported languages
                const hijriMonths = {
                    th: ['‡∏°‡∏π‡∏Æ‡∏±‡∏£‡∏£‡∏≠‡∏°', '‡∏ã‡∏≠‡∏ü‡∏±‡∏£', '‡∏£‡∏≠‡∏ö‡∏µ‡∏≠‡∏∏‡∏•‡πÄ‡∏≠‡∏≤‡∏ß‡∏±‡∏•', '‡∏£‡∏≠‡∏ö‡∏µ‡∏≠‡∏∏‡∏ã‡∏ã‡∏≤‡∏ô‡∏µ', '‡∏à‡∏π‡∏°‡∏≤‡∏î‡∏¥‡∏•‡πÄ‡∏≠‡∏≤‡∏ß‡∏±‡∏•', '‡∏à‡∏π‡∏°‡∏≤‡∏î‡∏¥‡∏ã‡∏ã‡∏≤‡∏ô‡∏µ', '‡∏£‡∏≠‡∏ç‡∏±‡∏ö', '‡∏ä‡∏∞‡∏≠‡πå‡∏ö‡∏≤‡∏ô', '‡πÄ‡∏£‡∏≤‡∏∞‡∏°‡∏∞‡∏é‡∏≠‡∏ô', '‡πÄ‡∏ä‡∏≤‡∏ß‡∏≤‡∏•', '‡∏ã‡∏∏‡∏•‡∏Å‡∏≠‡∏î‡∏∞‡∏Æ‡πå', '‡∏ã‡∏∏‡∏•‡∏Æ‡∏¥‡∏à‡∏ç‡∏∞‡∏Æ‡πå'],
                    en: ['Muharram', 'Safar', 'Rabi\' al-Awwal', 'Rabi\' al-Thani', 'Jumada al-Awwal', 'Jumada al-Thani', 'Rajab', 'Sha\'ban', 'Ramadan', 'Shawwal', 'Dhu al-Qi\'dah', 'Dhu al-Hijjah'],
                    ms: ['Muharram', 'Safar', 'Rabiulawal', 'Rabiulakhir', 'Jamadilawal', 'Jamadilakhir', 'Rejab', 'Syaaban', 'Ramadhan', 'Syawal', 'Zulkaedah', 'Zulhijjah']
                };

                // Get parts from Intl (Reliable for numbers)
                const parts = new Intl.DateTimeFormat('en-u-ca-islamic-umalqura', {
                    day: 'numeric', month: 'numeric', year: 'numeric'
                }).formatToParts(hijriDate);

                const d = parts.find(p => p.type === 'day').value;
                const m = parseInt(parts.find(p => p.type === 'month').value);
                const y = parts.find(p => p.type === 'year').value;

                // Use our own month labels
                const monthName = hijriMonths[currentLang][m - 1];
                document.getElementById('hijri-date-text').innerText = `${d} ${monthName} ${y} H`;

                const badge = document.getElementById('hijri-offset-badge');
                if (hijriOffset !== 0) {
                    badge.innerText = (hijriOffset > 0 ? '+' : '') + hijriOffset + 'd';
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            } catch (e) {
                console.error("Hijri error:", e);
                document.getElementById('hijri-date-text').innerText = '';
            }

            const todayData = prayerData.prayer_time.find(p => p["date-month"] === todayKey) || prayerData.prayer_time[0];

            const prayerNames = t.prayerNames;

            const icons = {
                imsak: "fa-hourglass-start",
                subuh: "fa-cloud-moon",
                terbit: "fa-sun",
                zohor: "fa-circle-half-stroke",
                asar: "fa-cloud-sun",
                maghrib: "fa-moon",
                isyak: "fa-star-and-crescent"
            };

            prayerList.innerHTML = '';
            const currentTotalMin = now.getHours() * 60 + now.getMinutes();

            // Reset current banner
            const currentBanner = document.getElementById('current-prayer-banner');
            currentBanner.classList.add('hidden');

            // JSON stores PM prayers in 12-hour style (e.g. asar:"3:49" ‚Üí should be 15:49)
            const PM_PRAYERS = ['asar', 'maghrib', 'isyak'];
            function normalizePrayerTime(key, timeStr) {
                const [h, m] = timeStr.split(':').map(Number);
                const h24 = PM_PRAYERS.includes(key) && h < 12 ? h + 12 : h;
                return `${String(h24).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
            }

            const PRAYER_ORDER = ['imsak', 'subuh', 'terbit', 'zohor', 'asar', 'maghrib', 'isyak'];
            const allEntries = PRAYER_ORDER
                .filter(k => todayData.times[k] !== undefined)
                .map(k => [k, normalizePrayerTime(k, todayData.times[k])]);

            // Find next prayer index (first after current time)
            let nextIndex = allEntries.findIndex(([key, timeStr]) => {
                const finalTime = applyOffset(timeStr, offset);
                const [h, m] = finalTime.split(':').map(Number);
                return (h * 60 + m) > currentTotalMin;
            });

            // Current prayer = one before next (or last if all passed)
            let currentIndex = nextIndex === -1
                ? allEntries.length - 1
                : nextIndex === 0 ? -1 : nextIndex - 1;

            // Special rule: Terbit (Syuruk) is only highlighted for 10 min after it begins.
            // After that it is treated as a plain past prayer.
            if (currentIndex >= 0 && allEntries[currentIndex][0] === 'terbit') {
                const terbitFinal = applyOffset(allEntries[currentIndex][1], offset);
                const [th2, tm2] = terbitFinal.split(':').map(Number);
                if (currentTotalMin - (th2 * 60 + tm2) > 10) {
                    currentIndex = -1;
                }
            }

            // Populate banner & widget from current/next
            if (currentIndex >= 0) {
                const [curKey, curTimeStr] = allEntries[currentIndex];
                const curTime = applyOffset(curTimeStr, offset);
                document.getElementById('current-prayer-label').innerText = prayerNames[curKey];
                document.getElementById('current-prayer-time-label').innerText = curTime;
                currentBanner.classList.remove('hidden');
            }
            const nextEntry = nextIndex !== -1 ? allEntries[nextIndex] : null;
            if (nextEntry) {
                const nextFinal = applyOffset(nextEntry[1], offset);
                const [nh, nm] = nextFinal.split(':').map(Number);
                updateWidget(prayerNames[nextEntry[0]], nextFinal, (nh * 60 + nm) - currentTotalMin);
            } else {
                updateWidget(t.done, '--:--', 0);
            }

            // Render ALL entries in fixed chronological order (earliest ‚Üí latest)
            allEntries.forEach(([key, timeStr], idx) => {
                const finalTime = applyOffset(timeStr, offset);
                const [h, m] = finalTime.split(':').map(Number);
                const prayerTotalMin = h * 60 + m;

                const isCurrent = idx === currentIndex && currentIndex >= 0;
                const isPast = !isCurrent && prayerTotalMin <= currentTotalMin;

                const card = document.createElement('div');

                if (isCurrent) {
                    card.className = "active-prayer-card glass-card p-2.5 flex justify-between items-center transition-all duration-300";
                    card.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="w-9 h-9 rounded-xl flex items-center justify-center bg-white/20 text-white text-lg">
                                <i class="fas ${icons[key]}"></i>
                            </div>
                            <div>
                                <p class="text-base font-bold text-white">${prayerNames[key]}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-lg font-bold tracking-tight text-white">${finalTime}</p>
                            <p class="text-[11px] text-white/70 mt-0.5">${T[currentLang].inProgress}</p>
                        </div>
                    `;
                } else {
                    card.className = "glass-card p-2.5 flex justify-between items-center transition-all duration-300";
                    card.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="w-9 h-9 rounded-xl flex items-center justify-center bg-emerald-500/5 text-emerald-500 text-lg">
                                <i class="fas ${icons[key]}"></i>
                            </div>
                            <div>
                                <p class="text-base font-bold text-slate-800 dark:text-slate-200">${prayerNames[key]}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-lg font-bold tracking-tight text-slate-700 dark:text-slate-200">${finalTime}</p>
                        </div>
                    `;
                }
                prayerList.appendChild(card);
            });

            // Rebuild month table
            buildMonthTable(t, offset);
        }

        let _tableSelectsInit = false;

        function buildMonthTable(t, offset) {
            const PRAYER_ORDER = ['imsak', 'subuh', 'terbit', 'zohor', 'asar', 'maghrib', 'isyak'];
            const PM_PRAYERS = ['asar', 'maghrib', 'isyak'];
            const now = new Date();
            const monthSel = document.getElementById('table-month-select');

            if (!_tableSelectsInit) {
                _tableSelectsInit = true;

                // The JSON date-month format is "day-month" (no year).
                // Populate year dropdown with current year ¬±1 to +2
                for (let m = 1; m <= 12; m++) {
                    const o = document.createElement('option');
                    o.value = m;
                    o.textContent = new Date(2000, m - 1, 1).toLocaleDateString(t.dateLocale, { month: 'long' });
                    monthSel.appendChild(o);
                }
                monthSel.value = now.getMonth() + 1;
                monthSel.addEventListener('change', () => buildMonthTable(T[currentLang], parseInt(document.getElementById('location-select').value)));
            }

            const selMonth = parseInt(monthSel.value);
            const selYear = now.getFullYear();
            const todayDate = now.getDate();
            const isThisMonth = selMonth === (now.getMonth() + 1) && selYear === now.getFullYear();

            // Filter by month only (JSON has no year ‚Äî data is one calendar year repeated)
            const monthRows = prayerData.prayer_time.filter(p => {
                const parts = p["date-month"].split('-').map(Number);
                return parts[1] === selMonth;
            }).sort((a, b) => a.date - b.date);

            if (!monthRows.length) {
                document.getElementById('month-table-body').innerHTML =
                    '<tr><td colspan="8" class="text-center py-6 text-slate-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
                return;
            }

            const d = new Date(selYear, selMonth - 1, 1);
            document.getElementById('lbl-month-table').innerText =
                d.toLocaleDateString(t.dateLocale, { month: 'long', year: 'numeric' });

            const head = document.getElementById('month-table-head');
            const thBase = 'px-3 py-2.5 text-center font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider whitespace-nowrap';
            head.innerHTML = `<th class="${thBase} text-left sticky left-0 bg-white/80 dark:bg-slate-900/80 z-10"><span class="block">#</span><span class="block text-[9px] text-emerald-500/60 font-normal normal-case">ŸáŸÄ</span></th>`
                + PRAYER_ORDER.map(k => `<th class="${thBase}">${t.prayerNames[k] || k}</th>`).join('');

            const tbody = document.getElementById('month-table-body');
            tbody.innerHTML = '';

            monthRows.forEach(row => {
                const isToday = isThisMonth && row.date === todayDate;
                const tr = document.createElement('tr');
                tr.className = isToday
                    ? 'bg-emerald-500 text-white font-bold'
                    : 'border-b border-slate-100/60 dark:border-slate-700/40 hover:bg-slate-50/50 dark:hover:bg-slate-800/30 transition-colors';
                const tdDay = document.createElement('td');
                tdDay.className = `px-3 py-2 text-left font-bold sticky left-0 z-10 ${isToday ? 'bg-emerald-500 text-white' : 'bg-white/80 dark:bg-slate-900/80 text-slate-600 dark:text-slate-300'
                    }`;

                // Gregorian day number
                const span1 = document.createElement('span');
                span1.className = 'block';
                span1.textContent = row.date;
                tdDay.appendChild(span1);

                // Hijri day number (with offset)
                try {
                    const hijriOffset = parseInt(localStorage.getItem('hijri-offset') || '0');
                    const gregDate = new Date(selYear, selMonth - 1, row.date);
                    const hijriDateObj = new Date(gregDate.getTime() + hijriOffset * 86400000);
                    const hDay = new Intl.DateTimeFormat('en-u-ca-islamic-umalqura', { day: 'numeric' }).format(hijriDateObj);
                    const hMonth = new Intl.DateTimeFormat('en-u-ca-islamic-umalqura', { month: 'numeric' }).format(hijriDateObj);
                    const span2 = document.createElement('span');
                    span2.className = `block text-[9px] font-normal ${isToday ? 'text-white/70' : 'text-emerald-500/70'}`;
                    span2.textContent = hDay + '/' + hMonth;
                    tdDay.appendChild(span2);
                } catch (e) { }

                tr.appendChild(tdDay);
                PRAYER_ORDER.forEach(k => {
                    const raw = row.times[k];
                    const td = document.createElement('td');
                    td.className = `px-3 py-2 text-center tabular-nums ${isToday ? 'text-white' : 'text-slate-700 dark:text-slate-300'
                        }`;
                    if (raw) {
                        const [h, m] = raw.split(':').map(Number);
                        const h24 = PM_PRAYERS.includes(k) && h < 12 ? h + 12 : h;
                        td.textContent = applyOffset(`${String(h24).padStart(2, '0')}:${String(m).padStart(2, '0')}`, offset);
                    } else { td.textContent = '‚Äî'; }
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
        }

        // Stores the next-prayer target as a Date object (set by updateWidget)
        let _nextPrayerTarget = null;

        function updateWidget(name, time, diffMin) {
            document.getElementById('next-prayer-name').innerText = name;
            document.getElementById('next-prayer-time').innerText = time;

            if (diffMin > 0) {
                // Calculate exact target time
                const now = new Date();
                _nextPrayerTarget = new Date(now.getTime() + diffMin * 60 * 1000);
                // Align to the prayer's exact minute (strip seconds from the diff)
                // We set seconds to 0 so the countdown starts from :00
                _nextPrayerTarget.setSeconds(0, 0);
            } else {
                _nextPrayerTarget = null;
            }

            tickCountdown(); // Immediate tick so no 1s delay on load
        }

        function tickCountdown() {
            const pad = n => String(n).padStart(2, '0');

            // Live clock (left side of card)
            const now = new Date();
            const clockEl = document.getElementById('live-clock');
            if (clockEl) {
                clockEl.innerText = `${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;
            }

            // Countdown to next prayer
            const el = document.getElementById('countdown-text');
            if (!_nextPrayerTarget) {
                el.innerText = T[currentLang].endOfDay;
                return;
            }
            const diffMs = _nextPrayerTarget - Date.now();
            if (diffMs <= 0) {
                el.innerText = T[currentLang].inPeriod;
                return;
            }
            const totalSec = Math.floor(diffMs / 1000);
            const hh = Math.floor(totalSec / 3600);
            const mm = Math.floor((totalSec % 3600) / 60);
            const ss = totalSec % 60;
            el.innerText = hh > 0
                ? `- ${hh}:${pad(mm)}:${pad(ss)}`
                : `- ${pad(mm)}:${pad(ss)}`;
        }

        function applyOffset(timeStr, offsetMin) {
            const [h, m] = timeStr.split(':').map(Number);
            let total = h * 60 + m + offsetMin;
            const newH = Math.floor(total / 60) % 24;
            const newM = total % 60;
            return `${newH.toString().padStart(2, '0')}:${newM.toString().padStart(2, '0')}`;
        }

        window.onload = () => { /* initApp is called after fetch completes */ };
    </script>
    <!-- Service Worker + PWA Install -->
    <script>
        // ‚îÄ‚îÄ Install prompt ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let _installPrompt = null;

        const installBanner = document.getElementById('pwa-install-banner');
        const installHint = document.getElementById('pwa-install-hint');

        // Check standalone status
        const isStandalone = window.matchMedia('(display-mode: standalone)').matches
            || window.navigator.standalone === true;

        if (!isStandalone) {
            installBanner.classList.remove('hidden');
        }

        // Native install prompt (Chrome / Android / Edge)
        window.addEventListener('beforeinstallprompt', e => {
            e.preventDefault();
            _installPrompt = e;
            installHint.innerText = '‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏•‡∏á‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á';
        });

        document.getElementById('pwa-install-btn').addEventListener('click', async () => {
            if (_installPrompt) {
                _installPrompt.prompt();
                const { outcome } = await _installPrompt.userChoice;
                if (outcome === 'accepted') {
                    installBanner.classList.add('hidden');
                    _installPrompt = null;
                }
            } else {
                // FALLBACK: Detailed manual instructions
                const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
                const isChrome = /chrome|chromium|crios/i.test(navigator.userAgent);

                if (isIOS) {
                    installHint.innerHTML = '<span class="text-emerald-500 font-bold">üì≤ ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏ä‡∏£‡πå [‚Üë] ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "Add to Home Screen"</span>';
                } else if (!window.isSecureContext) {
                    installHint.innerHTML = '<span class="text-red-500 font-bold">‚ö†Ô∏è ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ú‡πà‡∏≤‡∏ô HTTPS (SSL) ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</span>';
                } else {
                    installHint.innerHTML = '<span class="text-emerald-500 font-bold">üì≤ ‡∏Å‡∏î‡πÄ‡∏°‡∏ô‡∏π‡∏à‡∏∏‡∏î 3 ‡∏à‡∏∏‡∏î (‚ãÆ) ‚Üí ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏≠‡∏õ"</span>';
                }
            }
        });

        document.getElementById('pwa-dismiss-btn').addEventListener('click', () => {
            installBanner.classList.add('hidden');
        });

        window.addEventListener('appinstalled', () => {
            installBanner.classList.add('hidden');
        });

        // ‚îÄ‚îÄ Service Worker ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        if ('serviceWorker' in navigator) {
            let versionFetched = false;
            let notifiedPrayers = JSON.parse(localStorage.getItem('notified-today') || '{}');
            const todayStr = new Date().toDateString();

            if (notifiedPrayers.date !== todayStr) {
                notifiedPrayers = { date: todayStr };
            }

            // 1. Listen for version from SW
            navigator.serviceWorker.addEventListener('message', event => {
                if (event.data && event.data.type === 'VERSION') {
                    const el = document.getElementById('app-version');
                    if (el) el.innerText = event.data.value;
                    versionFetched = true;
                }
            });

            // 2. Register SW
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(reg => {
                        console.log('‚úÖ SW registered:', reg.scope);
                        reg.update().catch(() => { });
                    })
                    .catch(err => console.warn('‚ö†Ô∏è SW failed:', err));
            });

            // 3. Notification Handling
            const notiBtn = document.getElementById('noti-toggle');
            const notiIcon = document.getElementById('noti-icon');

            const updateNotiUI = () => {
                const isEnabled = localStorage.getItem('noti-enabled') === 'true' && Notification.permission === 'granted';
                notiIcon.className = isEnabled ? 'fas fa-bell text-emerald-500' : 'fas fa-bell-slash';
            };

            notiBtn.addEventListener('click', async () => {
                console.log('Notification button clicked');
                if (!('Notification' in window)) {
                    // Specific message for iOS
                    const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
                    if (isIOS && !window.navigator.standalone) {
                        return alert('‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö iPhone: ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏≠‡∏õ (Add to Home Screen) ‡∏Å‡πà‡∏≠‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡∏ö');
                    }
                    return alert('‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô');
                }

                if (!window.isSecureContext) {
                    return alert('‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ú‡πà‡∏≤‡∏ô HTTPS (SSL) ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô');
                }

                if (Notification.permission === 'denied') {
                    return alert('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ "‡∏ö‡∏•‡πá‡∏≠‡∏Å" ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÑ‡∏ß‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï (Reset Permission)');
                }

                if (Notification.permission !== 'granted') {
                    const permission = await Notification.requestPermission();
                    if (permission !== 'granted') {
                        return alert('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏î "‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï" (Allow) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô');
                    }
                }

                const currentState = localStorage.getItem('noti-enabled') === 'true';
                localStorage.setItem('noti-enabled', !currentState);
                updateNotiUI();

                if (!currentState) {
                    console.log('Sending test notification...');
                    // Try to show via Service Worker if possible (better for PWA)
                    navigator.serviceWorker.ready.then(reg => {
                        reg.showNotification('TAQWEEM', {
                            body: '‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                            icon: 'taqweem.png',
                            badge: 'taqweem.png'
                        });
                    }).catch(() => {
                        // Fallback to simple notification
                        new Notification('TAQWEEM', { body: '‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß' });
                    });
                }
            });

            const checkPrayerNotifications = () => {
                if (localStorage.getItem('noti-enabled') !== 'true' || Notification.permission !== 'granted' || !prayerData) return;

                const now = new Date();
                const curTime = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;

                const locSelect = document.getElementById('location-select');
                if (!locSelect) return;

                const offset = parseInt(locSelect.value);
                const todayKey = `${now.getDate()}-${now.getMonth() + 1}`;
                const todayData = prayerData.prayer_time.find(p => p["date-month"] === todayKey);

                if (!todayData) return;

                ['subuh', 'zohor', 'asar', 'maghrib', 'isyak'].forEach(pKey => {
                    const pTime = applyOffset(todayData[pKey], offset);
                    if (pTime === curTime && !notifiedPrayers[pKey]) {
                        const pName = T[currentLang].prayerNames[pKey];
                        const msg = `‡∏ñ‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏•‡∏∞‡∏´‡∏°‡∏≤‡∏î ${pName} ‡πÅ‡∏•‡πâ‡∏ß (${pTime})`;

                        navigator.serviceWorker.ready.then(reg => {
                            reg.showNotification('TAQWEEM', {
                                body: msg,
                                icon: 'taqweem.png',
                                badge: 'taqweem.png',
                                vibrate: [200, 100, 200, 100, 200],
                                tag: 'prayer-time-' + pKey,
                                renotify: true,
                                data: { url: window.location.href }
                            });
                        });

                        notifiedPrayers[pKey] = true;
                        localStorage.setItem('notified-today', JSON.stringify(notifiedPrayers));
                    }
                });
            };

            setInterval(checkPrayerNotifications, 60000);
            updateNotiUI();

            // 4. Request version with polling
            let attempts = 0;
            const requestVersion = () => {
                if (versionFetched || attempts > 10) return;
                attempts++;

                const sw = navigator.serviceWorker.controller;
                if (sw) {
                    sw.postMessage('GET_VERSION');
                } else {
                    navigator.serviceWorker.ready.then(reg => {
                        if (reg.active) reg.active.postMessage('GET_VERSION');
                    });
                }

                if (!versionFetched) {
                    setTimeout(requestVersion, 2000);
                }
            };
            setTimeout(requestVersion, 2000);
        }
    </script>
</body>


</html>

